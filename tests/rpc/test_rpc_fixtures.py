import json

from evm.rpc import RPCServer
from evm.rpc.format import (
    fixture_state_in_rpc_format,
)


chain_fixture = {
    "_info": {
        "comment": "",
        "filledwith": "cpp-1.3.0+commit.70e7d177.Linux.g++",
        "source": "../../tests/src/BlockchainTestsFiller/bcValidBlockTest/dataTxFiller.json"
    },
    "blocks": [
        {
            "blockHeader": {
                "bloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                "coinbase": "0x8888f1f195afa192cfee860698584c030f4c9db1",
                "difficulty": "0x020000",
                "extraData": "",
                "gasLimit": "0x2fefba",
                "gasUsed": "0x00",
                "hash": "0xe932b23f84c3b28afb6bdc5ab36377ab510b5c3913c7e5646d1a2d6536e13934",
                "mixHash": "0x7e747686cc66c89b48bb295df8acf06c0a06e9893c79e0e829bdd778d53d0063",
                "nonce": "0x71f452524892b4f2",
                "number": "0x01",
                "parentHash": "0x636aff25807a6331b7c9a8e4c984f3f8e38d7608adf34ee801f5265ca4fe19ac",
                "receiptTrie": "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
                "stateRoot": "0xb9985a0b5c09bb476161bcd55aa5fddf7601e4791b19b9b192b99bd74384edeb",
                "timestamp": "0x59af0130",
                "transactionsTrie": "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
                "uncleHash": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347"
            },
            "rlp": "0xf901fcf901f7a0636aff25807a6331b7c9a8e4c984f3f8e38d7608adf34ee801f5265ca4fe19aca01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948888f1f195afa192cfee860698584c030f4c9db1a0b9985a0b5c09bb476161bcd55aa5fddf7601e4791b19b9b192b99bd74384edeba056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008302000001832fefba808459af013080a07e747686cc66c89b48bb295df8acf06c0a06e9893c79e0e829bdd778d53d00638871f452524892b4f2c0c0",
            "transactions": [
            ],
            "uncleHeaders": [
            ]
        }
    ],
    "genesisBlockHeader": {
        "bloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "coinbase": "0x8888f1f195afa192cfee860698584c030f4c9db1",
        "difficulty": "0x020000",
        "extraData": "0x42",
        "gasLimit": "0x2fefd8",
        "gasUsed": "0x64",
        "hash": "0x636aff25807a6331b7c9a8e4c984f3f8e38d7608adf34ee801f5265ca4fe19ac",
        "mixHash": "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
        "nonce": "0x0102030405060708",
        "number": "0x00",
        "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "receiptTrie": "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
        "stateRoot": "0xcafd881ab193703b83816c49ff6c2bf6ba6f464a1be560c42106128c8dbc35e7",
        "timestamp": "0x54c98c81",
        "transactionsTrie": "0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
        "uncleHash": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347"
    },
    "genesisRLP": "0xf901fcf901f7a00000000000000000000000000000000000000000000000000000000000000000a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347948888f1f195afa192cfee860698584c030f4c9db1a0cafd881ab193703b83816c49ff6c2bf6ba6f464a1be560c42106128c8dbc35e7a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008302000080832fefd8648454c98c8142a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421880102030405060708c0c0",
    "lastblockhash": "0xe932b23f84c3b28afb6bdc5ab36377ab510b5c3913c7e5646d1a2d6536e13934",
    "network": "Byzantium",
    "postState": {
        "0x8888f1f195afa192cfee860698584c030f4c9db1": {
            "balance": "0x29a2241af62c0000",
            "code": "",
            "nonce": "0x00",
            "storage": {
            }
        },
        "0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b": {
            "balance": "0x02540be400",
            "code": "",
            "nonce": "0x00",
            "storage": {
            }
        }
    },
    "pre": {
        "0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b": {
            "balance": "0x02540be400",
            "code": "",
            "nonce": "0x00",
            "storage": {
            }
        }
    }
}


def build_request(method, params):
    return {"jsonrpc": "2.0", "method": method, "params": params, "id": 3}


def result_from_response(response_str):
    response = json.loads(response_str)
    return (response.get('result', None), response.get('error', None))


def validate_one_account_state(fixture_key, rpc_method, rpc, state, addr):
    request = build_request(rpc_method, [addr, 'latest'])
    state_response = rpc.execute(request)
    state_result, state_error = result_from_response(state_response)
    assert state_result == state[fixture_key], "Invalid state - %s" % state_error


RPC_STATE_LOOKUPS = (
    ('balance', 'eth_getBalance'),
    ('code', 'eth_getCode'),
    ('nonce', 'eth_getTransactionCount'),
)


def validate_account_states(rpc, state, addr):
    standardized_state = fixture_state_in_rpc_format(state)
    for fixture_key, rpc_method in RPC_STATE_LOOKUPS:
        validate_one_account_state(fixture_key, rpc_method, rpc, standardized_state, addr)


def test_rpc_against_fixtures():
    rpc = RPCServer(None)
    setup_request = build_request('debug_resetChainTo', [chain_fixture])
    setup_response = rpc.execute(setup_request)
    setup_result, setup_error = result_from_response(setup_response)
    assert setup_result is True and setup_error is None

    for addr in chain_fixture['postState']:
        validate_account_states(rpc, chain_fixture['postState'][addr], addr)
